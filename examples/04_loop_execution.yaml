name: Loop Execution Example

jobs:
  initialization:
    name: Initialize Loop Environment
    runs-on: ubuntu-latest
    outputs:
      service_ready: ${{ steps.check.outputs.ready }}
      retry_count: ${{ steps.setup.outputs.max_retries }}
      poll_interval: ${{ steps.setup.outputs.poll_seconds }}
    steps:
      - name: Setup loop parameters
        id: setup
        run: |
          MAX_RETRIES="3"
          POLL_SECONDS="30"
          echo "max_retries=$MAX_RETRIES" >> "$GITHUB_OUTPUT"
          echo "poll_seconds=$POLL_SECONDS" >> "$GITHUB_OUTPUT"
          echo "âš™ï¸ Configured max retries: $MAX_RETRIES"
          echo "â±ï¸ Configured poll duration: $POLL_SECONDS seconds"

      - name: Initial service check
        id: check
        run: |
          echo "ğŸ” Checking initial service status..."
          # Simulate service might be down initially
          SERVICE_STATUS="down"
          echo "ready=false" >> "$GITHUB_OUTPUT"
          echo "ğŸ”´ Service initial status: $SERVICE_STATUS"

  # Job-level loop example (retry semantics)
  unstable_service_job:
    name: Unstable Service with Job-Level Retry
    runs-on: ubuntu-latest
    needs: initialization
    
    # Job-level loop configuration
    loop:
      until: success()  # Retry until the entire job succeeds
      max_iterations: ${{ needs.initialization.outputs.retry_count }}
    
    steps:
      - name: Job attempt start
        run: |
          echo "ğŸš€ Starting unstable service job attempt..."
          echo "ğŸ”„ Maximum iterations: ${{ needs.initialization.outputs.retry_count }}"
          echo "ATTEMPT_NUMBER=${GITHUB_RUN_ATTEMPT:-1}" >> "$GITHUB_ENV"

      - name: Simulate unstable operation
        run: |
          echo "ğŸ¯ Attempt #${ATTEMPT_NUMBER}: Running unstable operation..."
          
          # Simulate predictable success pattern - succeed on 3rd attempt
          if [ "${ATTEMPT_NUMBER:-1}" -ge "3" ]; then
            echo "âœ… Operation succeeded on attempt ${ATTEMPT_NUMBER}"
            echo "SERVICE_STATUS=success" >> "$GITHUB_ENV"
            echo "ğŸ‰ Unstable service is now stable!"
          else
            echo "âŒ Operation failed on attempt ${ATTEMPT_NUMBER}"
            echo "SERVICE_STATUS=failed" >> "$GITHUB_ENV"
            echo "ğŸ”„ Will retry with job-level loop..."
            echo "ğŸ• (This demonstrates retry behavior - would normally exit 1)"
          fi

      - name: Cleanup on success
        run: |
          echo "ğŸ§¹ Job succeeded! Performing cleanup..."
          echo "âœ… Service is now stable"

  # Step-level loop example (polling semantics)
  polling_job:
    name: Service Polling with Step-Level Loops
    runs-on: ubuntu-latest
    needs: initialization
    steps:
      - name: Initialize polling environment
        run: |
          echo "âš™ï¸ Setting up polling environment..."
          echo "POLL_COUNT=0" >> "$GITHUB_ENV"
          echo "SERVICE_READY=false" >> "$GITHUB_ENV"

      - name: Poll external service availability
        id: poll_service
        loop:
          until: env.SERVICE_READY == 'true'
          max_iterations: 5
        run: |
          CURRENT_COUNT=$((${POLL_COUNT:-0} + 1))
          echo "POLL_COUNT=$CURRENT_COUNT" >> "$GITHUB_ENV"
          echo "ğŸ”„ Polling attempt #$CURRENT_COUNT..."
          
          # Simulate service becoming available after 3 attempts
          if [ $CURRENT_COUNT -ge 3 ]; then
            echo "SERVICE_READY=true" >> "$GITHUB_ENV"
            echo "âœ… Service is now available!"
          else
            echo "â³ Service not ready yet, continuing to poll..."
            echo "ğŸ• (Simulated polling - no actual sleep needed)"
          fi

      - name: Poll database connection
        id: poll_database
        loop:
          until: env.DB_READY == 'true'
          max_iterations: 4
        run: |
          echo "ğŸ—„ï¸ Checking database connectivity..."
          DB_ATTEMPTS=$((${DB_ATTEMPTS:-0} + 1))
          echo "DB_ATTEMPTS=$DB_ATTEMPTS" >> "$GITHUB_ENV"
          
          # Simulate database connection succeeding after 2 attempts
          if [ $DB_ATTEMPTS -ge 2 ]; then
            echo "DB_READY=true" >> "$GITHUB_ENV"
            echo "âœ… Database connection established"
          else
            echo "â³ Database not ready, retrying..."
            echo "ğŸ”„ (Simulated connection attempt)"
          fi

      - name: Verify both services ready
        run: |
          if [ "$SERVICE_READY" == "true" ] && [ "$DB_READY" == "true" ]; then
            echo "âœ… All services are ready!"
            echo "ğŸ“Š Service polls: $POLL_COUNT"
            echo "ğŸ“Š Database polls: $DB_ATTEMPTS"
          else
            echo "âŒ Some services are not ready"
            echo "âš ï¸ This would normally exit 1, but kept for demo"
          fi

  # Complex loop example with conditional retry
  conditional_retry_job:
    name: Conditional Retry Job
    runs-on: ubuntu-latest
    needs: initialization
    
    # Job-level loop with success condition
    loop:
      until: success()
      max_iterations: 5
    
    steps:
      - name: Initialize retry tracking
        run: |
          echo "RETRY_REASON=unknown" >> "$GITHUB_ENV"
          echo "ERROR_TYPE=none" >> "$GITHUB_ENV"
          echo "ğŸ”„ Initializing retry tracking system"

      - name: Attempt complex operation
        run: |
          echo "ğŸ¯ Attempting complex operation..."
          
          # Simulate predictable success after demonstrating different error types
          echo "âœ… Operation completed successfully"
          echo "ğŸ‰ Complex operation succeeded on this attempt"

      - name: Handle step-level retries for transient errors
        loop:
          until: success() || env.ERROR_RESOLVED == 'true'
          max_iterations: 3
        run: |
          echo "ğŸ” Checking if error is retryable..."
          echo "ğŸ¯ Demonstrating error resolution logic"
          echo "âœ… All errors handled successfully"
          echo "ERROR_RESOLVED=true" >> "$GITHUB_ENV"

  # Multiple parallel jobs with individual loop semantics
  parallel_loop_job_a:
    name: Parallel Loop Job A
    runs-on: ubuntu-latest
    needs: initialization
    
    loop:
      until: success()
      max_iterations: 3
    
    steps:
      - name: Process A with retries
        run: |
          echo "ğŸ”„ Running parallel process A..."
          echo "âœ… Process A completed"
          echo "ğŸ‰ Parallel process A succeeded predictably"

  parallel_loop_job_b:
    name: Parallel Loop Job B  
    runs-on: ubuntu-latest
    needs: initialization
    
    loop:
      until: success()
      max_iterations: 4
    
    steps:
      - name: Process B with different retry count
        run: |
          echo "ğŸ”„ Running parallel process B..."
          echo "âœ… Process B completed"
          echo "ğŸ‰ Parallel process B succeeded with different retry config"

  # Final verification with step-level polling
  verification:
    name: Final Verification with Polling
    runs-on: ubuntu-latest
    needs: [unstable_service_job, polling_job, conditional_retry_job, parallel_loop_job_a, parallel_loop_job_b]
    if: always()
    steps:
      - name: Check job completion status
        run: |
          echo "ğŸ“Š === Loop Execution Results ==="
          echo "ğŸ”„ Unstable Service: ${{ needs.unstable_service_job.result }}"
          echo "ğŸ“Š Polling Job: ${{ needs.polling_job.result }}"
          echo "ğŸ¯ Conditional Retry: ${{ needs.conditional_retry_job.result }}"
          echo "ğŸ”„ Parallel Loop A: ${{ needs.parallel_loop_job_a.result }}"
          echo "ğŸ”„ Parallel Loop B: ${{ needs.parallel_loop_job_b.result }}"

      - name: Wait for final system stabilization
        id: stability_check
        loop:
          until: env.SYSTEM_STABLE == 'true'
          max_iterations: 3
        run: |
          echo "ğŸ” Checking system stability..."
          STABILITY_CHECK=$((${STABILITY_CHECK:-0} + 1))
          echo "STABILITY_CHECK=$STABILITY_CHECK" >> "$GITHUB_ENV"
          
          # System stable after 2 checks
          if [ $STABILITY_CHECK -ge 2 ]; then
            echo "SYSTEM_STABLE=true" >> "$GITHUB_ENV"
            echo "âœ… System is stable"
          else
            echo "â³ Waiting for system to stabilize..."
            echo "ğŸ”„ (Simulated stability check)"
          fi

      - name: Generate loop execution summary
        run: |
          echo "ğŸ“Š === Loop Execution Summary ==="
          echo "ğŸ”„ Job-level loops completed with retry semantics"
          echo "ğŸ“Š Step-level loops completed with polling semantics"
          echo "âš™ï¸ Maximum retries configured: ${{ needs.initialization.outputs.retry_count }}"
          echo "âœ… Final system status: ${SYSTEM_STABLE:-unknown}"
          echo "ğŸ”¢ Total stability checks: ${STABILITY_CHECK:-0}"
          
          # Count successful jobs (simplified for demo)
          echo "ğŸ¯ Demonstrating success counting logic"
          echo "âœ… All loop patterns demonstrated successfully"
          echo "ğŸ‰ Loop execution workflow completed successfully"