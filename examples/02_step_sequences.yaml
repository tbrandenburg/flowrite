name: Step Sequences Example

jobs:
  preparation:
    name: Preparation Phase
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.versioning.outputs.version }}
      config_hash: ${{ steps.config.outputs.hash }}
      dependencies_ready: ${{ steps.deps.outputs.ready }}
    steps:
      - name: Validate input parameters
        run: |
          echo "âœ… Validating deployment target: staging"
          DEPLOYMENT_TARGET="staging"
          if [[ "$DEPLOYMENT_TARGET" =~ ^(staging|production)$ ]]; then
            echo "âœ… Valid deployment target"
          else
            echo "âŒ Invalid deployment target" && exit 1
          fi

      - name: Initialize environment variables
        run: |
          echo "TARGET_ENV=staging" >> "$GITHUB_ENV"
          echo "DEPLOY_TIMESTAMP=20260225_100000" >> "$GITHUB_ENV"
          echo "WORKSPACE_ROOT=/tmp/flowrite-deploy" >> "$GITHUB_ENV"
          echo "ğŸ”§ Environment variables initialized"

      - name: Create workspace structure
        run: |
          echo "ğŸ“ Workspace structure created at: ${WORKSPACE_ROOT}"
          echo "ğŸ“„ Created directories: source, build, config, logs"

      - name: Generate version information
        id: versioning
        run: |
          DEPLOYMENT_TARGET="staging"
          if [ "$DEPLOYMENT_TARGET" == "production" ]; then
            VERSION="v1.20260225.1000"
          else
            VERSION="v0.20260225.1000-staging"
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "ğŸ·ï¸ Generated version: $VERSION"

      - name: Load configuration
        id: config
        run: |
          echo "âš™ï¸ Loading configuration for ${TARGET_ENV}..."
          CONFIG_CONTENT="database_url=postgres://localhost:5432/flowrite_${TARGET_ENV}"
          CONFIG_HASH="abc12345"
          echo "hash=$CONFIG_HASH" >> "$GITHUB_OUTPUT"
          echo "âœ… Configuration loaded with hash: $CONFIG_HASH"

      - name: Check dependencies
        id: deps
        run: |
          echo "ğŸ” Checking system dependencies..."
          
          # Simulate dependency checks
          DEPS=("python3" "pip" "git" "curl")
          READY="true"
          
          for dep in "${DEPS[@]}"; do
            echo "âœ… $dep is available"
          done
          
          echo "ready=$READY" >> "$GITHUB_OUTPUT"
          echo "âœ… Dependencies check completed: $READY"

  build_phase:
    name: Build Phase
    runs-on: ubuntu-latest
    needs: preparation
    if: needs.preparation.outputs.dependencies_ready == 'true'
    steps:
      - name: Setup build environment
        run: |
          echo "ğŸ—ï¸ Setting up build for version: ${{ needs.preparation.outputs.version }}"
          echo "ğŸ”§ Config hash: ${{ needs.preparation.outputs.config_hash }}"
          echo "BUILD_VERSION=${{ needs.preparation.outputs.version }}" >> "$GITHUB_ENV"

      - name: Source code preparation
        run: |
          echo "ğŸ“ Preparing source code..."
          echo "ğŸ“ Creating mock source files at ${WORKSPACE_ROOT}/source/"
          echo "âœ… Source files prepared with version ${{ needs.preparation.outputs.version }}"

      - name: Install build dependencies
        run: |
          echo "ğŸ“¦ Installing build dependencies..."
          echo "âœ… Dependencies installed successfully"

      - name: Compile application
        run: |
          echo "ğŸ—ï¸ Compiling application with version ${BUILD_VERSION}..."
          echo "âœ… Application compiled successfully"
          echo "BUILD_ARTIFACT=${WORKSPACE_ROOT}/build/flowrite-${BUILD_VERSION}" >> "$GITHUB_ENV"

      - name: Run static analysis
        run: |
          echo "ğŸ” Running static analysis..."
          echo "ğŸ“Š Analyzing code quality..."
          echo "âœ… Static analysis completed - no issues found"

      - name: Execute unit tests
        run: |
          echo "ğŸ§ª Executing unit tests..."
          echo "ğŸƒ Running test suite..."
          echo "âœ… All 15 unit tests passed"

      - name: Generate build artifacts
        run: |
          echo "ğŸ“¦ Generating build artifacts at ${BUILD_ARTIFACT}..."
          echo "ğŸ“„ Build info generated with current timestamp"
          echo "âœ… Build artifacts generated successfully"

  testing_phase:
    name: Testing Phase
    runs-on: ubuntu-latest
    needs: [preparation, build_phase]
    steps:
      - name: Setup test environment
        run: |
          echo "ğŸ§ª Setting up test environment..."
          echo "ğŸ·ï¸ Version under test: ${{ needs.preparation.outputs.version }}"

      - name: Integration tests
        run: |
          echo "ğŸ”— Running integration tests..."
          echo "ğŸ—„ï¸ Testing database connections..."
          echo "ğŸŒ Testing API endpoints..."
          echo "âœ… Integration tests completed successfully"

      - name: Performance tests
        run: |
          echo "âš¡ Running performance tests..."
          echo "ğŸ‘¥ Load testing with 100 concurrent users..."
          echo "ğŸ“Š Average response time: 245ms"
          echo "âœ… Performance tests passed"

      - name: Security scan
        run: |
          echo "ğŸ”’ Running security scan..."
          echo "ğŸ” Scanning for vulnerabilities..."
          echo "âœ… Security scan completed - no critical issues found"

      - name: Generate test reports
        run: |
          echo "ğŸ“Š Generating test reports..."
          echo "ğŸ“ˆ Test coverage: 92%"
          echo "ğŸ›¡ï¸ Security score: A+"
          echo "âš¡ Performance score: 8.5/10"

  deployment_phase:
    name: Deployment Phase
    runs-on: ubuntu-latest
    needs: [build_phase, testing_phase]
    steps:
      - name: Pre-deployment checks
        run: |
          echo "ğŸš€ Running pre-deployment checks..."
          echo "ğŸ¯ Target environment: staging"
          echo "ğŸ·ï¸ Version: ${{ needs.preparation.outputs.version }}"

      - name: Database migrations
        run: |
          echo "ğŸ—„ï¸ Running database migrations..."
          echo "âœ… Database schema updated successfully"

      - name: Deploy application
        run: |
          echo "ğŸš€ Deploying version ${{ needs.preparation.outputs.version }}..."
          echo "ğŸ¯ Deployment target: staging"
          echo "âœ… Application deployed successfully"

      - name: Health checks
        run: |
          echo "ğŸ¥ Running post-deployment health checks..."
          echo "ğŸš€ Checking application startup..."
          echo "ğŸŒ Verifying endpoints..."
          echo "âœ… All health checks passed"

      - name: Deployment summary
        run: |
          echo "ğŸ“Š === Deployment Summary ==="
          echo "ğŸ·ï¸ Version: ${{ needs.preparation.outputs.version }}"
          echo "ğŸ¯ Environment: staging"
          echo "ğŸ”§ Config Hash: ${{ needs.preparation.outputs.config_hash }}"
          echo "â° Deployment Time: 2026-02-25T10:00:00Z"
          echo "âœ… Status: SUCCESS"