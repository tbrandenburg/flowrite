name: Foreach File Processing Example

jobs:
  preparation:
    name: Prepare File Lists
    runs-on: ubuntu-latest
    outputs:
      file_list: ${{ steps.generate.outputs.files }}
      config_list: ${{ steps.generate.outputs.configs }}
      env_types: ${{ steps.generate.outputs.environments }}
    steps:
      - name: Generate file lists for processing
        id: generate
        run: |
          # Create newline-separated file list
          FILES="data/input1.txt
          data/input2.txt
          data/input3.txt
          logs/app.log
          logs/error.log"
          echo "files=$FILES" >> "$GITHUB_OUTPUT"
          echo "ğŸ“„ Generated file list for processing"
          
          # Create space-separated config list
          CONFIGS="app.config db.config cache.config"
          echo "configs=$CONFIGS" >> "$GITHUB_OUTPUT"
          echo "âš™ï¸ Generated configuration files list"
          
          # Create environment types (space-separated)
          ENVIRONMENTS="development staging production"
          echo "environments=$ENVIRONMENTS" >> "$GITHUB_OUTPUT"
          echo "ğŸŒ± Generated environment types list"

      - name: Display preparation results
        run: |
          echo "ğŸ“Š === Preparation Results ==="
          echo "ğŸ“„ Files to process: ${{ steps.generate.outputs.files }}"
          echo "âš™ï¸ Config files: ${{ steps.generate.outputs.configs }}"
          echo "ğŸŒ± Environments: ${{ steps.generate.outputs.environments }}"

  # Step-level foreach example - process files within single job
  file_processing:
    name: Process Files with Step-Level Foreach
    runs-on: ubuntu-latest
    needs: preparation
    steps:
      - name: Initialize processing environment
        run: |
          echo "ğŸš€ Initializing file processing environment..."
          echo "PROCESSED_COUNT=0" >> "$GITHUB_ENV"
          echo "TOTAL_SIZE=0" >> "$GITHUB_ENV"
          echo "SUCCESS_COUNT=0" >> "$GITHUB_ENV"

      - name: Process each file
        id: process_files
        loop:
          foreach: ${{ needs.preparation.outputs.file_list }}
          max_iterations: 10
        run: |
          echo "ğŸ“„ Processing file: $FOREACH_ITEM"
          echo "ğŸ”¢ Item index: $FOREACH_INDEX (iteration $FOREACH_ITERATION)"
          
          # Simulate file processing based on file type
          case "$FOREACH_ITEM" in
            *.txt)
              echo "ğŸ“ Processing text file: $FOREACH_ITEM"
              FILE_SIZE="1024"
              echo "âœ… Text file processed successfully"
              ;;
            *.log)
              echo "ğŸ“Š Processing log file: $FOREACH_ITEM" 
              FILE_SIZE="2048"
              echo "âœ… Log file processed successfully"
              ;;
            *)
              echo "â“ Unknown file type: $FOREACH_ITEM"
              FILE_SIZE="512"
              echo "âš ï¸ Processed with default handler"
              ;;
          esac
          
          # Update counters
          NEW_PROCESSED=$((${PROCESSED_COUNT:-0} + 1))
          NEW_TOTAL_SIZE=$((${TOTAL_SIZE:-0} + $FILE_SIZE))
          NEW_SUCCESS=$((${SUCCESS_COUNT:-0} + 1))
          
          echo "PROCESSED_COUNT=$NEW_PROCESSED" >> "$GITHUB_ENV"
          echo "TOTAL_SIZE=$NEW_TOTAL_SIZE" >> "$GITHUB_ENV"  
          echo "SUCCESS_COUNT=$NEW_SUCCESS" >> "$GITHUB_ENV"
          
          echo "ğŸ“Š Processed: $NEW_PROCESSED | Total size: $NEW_TOTAL_SIZE bytes"

      - name: Validate each configuration
        id: validate_configs
        loop:
          foreach: ${{ needs.preparation.outputs.config_list }}
          max_iterations: 5
        run: |
          echo "âš™ï¸ Validating configuration: $FOREACH_ITEM"
          echo "ğŸ”¢ Config index: $FOREACH_INDEX (iteration $FOREACH_ITERATION)"
          
          # Simulate configuration validation
          case "$FOREACH_ITEM" in
            app.config)
              echo "ğŸ—ï¸ Validating application configuration..."
              echo "âœ… Application config is valid"
              ;;
            db.config)
              echo "ğŸ—„ï¸ Validating database configuration..."
              echo "âœ… Database config is valid"
              ;;
            cache.config)
              echo "ğŸ’¾ Validating cache configuration..."
              echo "âœ… Cache config is valid"
              ;;
            *)
              echo "â“ Unknown configuration: $FOREACH_ITEM"
              echo "âœ… Validated with default rules"
              ;;
          esac

      - name: Generate processing summary
        run: |
          echo "ğŸ“Š === File Processing Summary ==="
          echo "ğŸ“„ Files processed: ${PROCESSED_COUNT:-0}"
          echo "ğŸ“Š Total data size: ${TOTAL_SIZE:-0} bytes"
          echo "âœ… Successful operations: ${SUCCESS_COUNT:-0}"
          echo "âš™ï¸ Configurations validated: 3"
          echo "ğŸ‰ Step-level foreach processing completed"

  # Job-level foreach example - run entire job for each environment
  environment_deployment:
    name: Deploy to Environment
    runs-on: ubuntu-latest
    needs: [preparation, file_processing]
    
    # Job-level foreach - entire job runs for each environment
    loop:
      foreach: ${{ needs.preparation.outputs.env_types }}
      max_iterations: 5
    
    steps:
      - name: Initialize deployment
        run: |
          echo "ğŸš€ Starting deployment to: $FOREACH_ITEM"
          echo "ğŸ”¢ Environment index: $FOREACH_INDEX (iteration $FOREACH_ITERATION)"
          echo "ğŸŒ± Deploying to environment: $FOREACH_ITEM"
          
          # Set environment-specific variables
          echo "DEPLOY_ENV=$FOREACH_ITEM" >> "$GITHUB_ENV"
          echo "ENV_INDEX=$FOREACH_INDEX" >> "$GITHUB_ENV"
          echo "ENV_ITERATION=$FOREACH_ITERATION" >> "$GITHUB_ENV"

      - name: Configure environment-specific settings
        run: |
          echo "âš™ï¸ Configuring settings for: $DEPLOY_ENV"
          
          case "$DEPLOY_ENV" in
            development)
              echo "ğŸ› ï¸ Development environment configuration"
              echo "DEBUG_MODE=true" >> "$GITHUB_ENV"
              echo "REPLICAS=1" >> "$GITHUB_ENV"
              echo "LOG_LEVEL=debug" >> "$GITHUB_ENV"
              ;;
            staging)
              echo "ğŸ­ Staging environment configuration"
              echo "DEBUG_MODE=false" >> "$GITHUB_ENV"
              echo "REPLICAS=2" >> "$GITHUB_ENV"
              echo "LOG_LEVEL=info" >> "$GITHUB_ENV"
              ;;
            production)
              echo "ğŸ­ Production environment configuration"
              echo "DEBUG_MODE=false" >> "$GITHUB_ENV"
              echo "REPLICAS=3" >> "$GITHUB_ENV"
              echo "LOG_LEVEL=warn" >> "$GITHUB_ENV"
              ;;
          esac
          
          echo "âœ… Environment configured: $DEPLOY_ENV"

      - name: Deploy application
        run: |
          echo "ğŸš€ Deploying application to: $DEPLOY_ENV"
          echo "ğŸ”§ Debug mode: ${DEBUG_MODE:-unknown}"
          echo "ğŸ“Š Replicas: ${REPLICAS:-unknown}"
          echo "ğŸ“ Log level: ${LOG_LEVEL:-unknown}"
          
          # Simulate deployment steps
          echo "ğŸ“¦ Pushing application package..."
          echo "âš™ï¸ Updating configuration..."
          echo "ğŸ”„ Restarting services (${REPLICAS} replicas)..."
          echo "ğŸ” Running health checks..."
          
          echo "âœ… Deployment to $DEPLOY_ENV completed successfully"

      - name: Post-deployment verification
        run: |
          echo "ğŸ” Verifying deployment to: $DEPLOY_ENV"
          echo "ğŸ“Š Environment index: $ENV_INDEX"
          echo "ğŸ”¢ Deployment iteration: $ENV_ITERATION"
          
          # Simulate verification checks
          echo "ğŸŒ Checking service endpoints..."
          echo "ğŸ“Š Validating metrics collection..."
          echo "ğŸ”’ Verifying security settings..."
          
          echo "âœ… Verification completed for: $DEPLOY_ENV"
          echo "ğŸ‰ $DEPLOY_ENV deployment successful!"

  # Final verification job that processes results from all deployments
  final_verification:
    name: Final Verification and Reporting
    runs-on: ubuntu-latest
    needs: [preparation, file_processing, environment_deployment]
    if: always()
    steps:
      - name: Collect deployment results
        run: |
          echo "ğŸ“Š === Final Verification Report ==="
          echo "ğŸ“„ File Processing Status: ${{ needs.file_processing.result }}"
          echo "ğŸŒ± Environment Deployment Status: ${{ needs.environment_deployment.result }}"
          echo "âœ… All foreach operations completed"

      - name: Generate summary statistics
        run: |
          echo "ğŸ”¢ === Foreach Execution Statistics ==="
          echo "ğŸ“„ Files processed: Multiple files via step-level foreach"
          echo "âš™ï¸ Configurations validated: 3 configs via step-level foreach" 
          echo "ğŸŒ± Environments deployed: 3 environments via job-level foreach"
          echo "ğŸ”„ Total foreach iterations: File processing + Config validation + Environment deployments"

      - name: Verify foreach environment variables
        id: foreach_demo
        loop:
          foreach: "demo1 demo2 demo3"
          max_iterations: 5
        run: |
          echo "ğŸ§ª Demonstration of foreach environment variables:"
          echo "ğŸ“ FOREACH_ITEM: $FOREACH_ITEM"
          echo "ğŸ”¢ FOREACH_INDEX: $FOREACH_INDEX" 
          echo "ğŸ”„ FOREACH_ITERATION: $FOREACH_ITERATION"
          echo "âœ… Foreach variables working correctly"

      - name: Final success confirmation
        run: |
          echo "ğŸ‰ === Foreach File Processing Workflow Completed ==="
          echo "âœ… Step-level foreach: File and config processing completed"
          echo "âœ… Job-level foreach: Multi-environment deployment completed"
          echo "âœ… Variable demonstration: Foreach environment variables confirmed"
          echo "ğŸ“Š All foreach patterns demonstrated successfully"
          
          # Show final status
          echo "ğŸ Workflow execution completed successfully"
          echo "ğŸ“ˆ Foreach functionality fully validated"