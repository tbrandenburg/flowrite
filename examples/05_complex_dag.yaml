name: Complex DAG Example

jobs:
  # Root nodes - initial setup
  environment_setup:
    name: Environment Setup
    runs-on: ubuntu-latest
    outputs:
      env_name: ${{ steps.config.outputs.env_name }}
      canary_enabled: ${{ steps.config.outputs.canary_enabled }}
      performance_tests: ${{ steps.config.outputs.performance_tests }}
      infrastructure_ready: ${{ steps.infra.outputs.ready }}
      config_hash: ${{ steps.config.outputs.hash }}
    steps:
      - name: Configure environment
        id: config
        run: |
          echo "ğŸ”§ Configuring deployment environment..."
          ENV_NAME="staging"
          CANARY="false"
          PERF_TESTS="true"
          
          echo "env_name=$ENV_NAME" >> "$GITHUB_OUTPUT"
          echo "canary_enabled=$CANARY" >> "$GITHUB_OUTPUT"
          echo "performance_tests=$PERF_TESTS" >> "$GITHUB_OUTPUT"
          
          # Static config hash for educational purposes
          CONFIG_HASH="abc12345"
          echo "hash=$CONFIG_HASH" >> "$GITHUB_OUTPUT"
          
          echo "âœ… Environment configured: $ENV_NAME"
          echo "ğŸš¢ Canary deployment: $CANARY"  
          echo "âš¡ Performance tests: $PERF_TESTS"
          echo "ğŸ”‘ Config hash: $CONFIG_HASH"

      - name: Setup infrastructure
        id: infra
        run: |
          echo "ğŸ—ï¸ Setting up infrastructure for ${{ steps.config.outputs.env_name }}..."
          echo "ready=true" >> "$GITHUB_OUTPUT"
          echo "âœ… Infrastructure ready"

  security_scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    # Independent of environment setup - can run in parallel
    outputs:
      security_passed: ${{ steps.scan.outputs.passed }}
      vulnerabilities: ${{ steps.scan.outputs.vuln_count }}
    steps:
      - name: Run security scan
        id: scan
        run: |
          echo "ğŸ” Running comprehensive security scan..."
          echo "ğŸ” Scanning dependencies for vulnerabilities..."
          echo "ğŸ›¡ï¸ Checking code for security issues..."
          
          # Educational simulation of security findings
          VULN_COUNT=2
          PASSED=true  # Non-critical vulnerabilities
          
          echo "passed=$PASSED" >> "$GITHUB_OUTPUT"
          echo "vuln_count=$VULN_COUNT" >> "$GITHUB_OUTPUT"
          echo "âœ… Security scan completed: $VULN_COUNT non-critical vulnerabilities found"

  # First level dependencies
  source_preparation:
    name: Source Code Preparation  
    runs-on: ubuntu-latest
    needs: [environment_setup, security_scan]
    if: needs.security_scan.outputs.security_passed == true
    outputs:
      source_hash: ${{ steps.prep.outputs.hash }}
      build_ready: ${{ steps.prep.outputs.ready }}
    steps:
      - name: Prepare source code
        id: prep
        run: |
          echo "ğŸ“¦ Preparing source for environment: ${{ needs.environment_setup.outputs.env_name }}"
          echo "ğŸ”„ Checking out code and applying environment-specific configs..."
          
          # Static source hash for educational purposes
          SOURCE_HASH="src789abc"
          echo "hash=$SOURCE_HASH" >> "$GITHUB_OUTPUT"
          echo "ready=true" >> "$GITHUB_OUTPUT"
          echo "âœ… Source prepared with hash: $SOURCE_HASH"

  dependency_resolution:
    name: Dependency Resolution
    runs-on: ubuntu-latest
    needs: environment_setup
    outputs:
      deps_hash: ${{ steps.resolve.outputs.hash }}
      cache_hit: ${{ steps.resolve.outputs.cache_hit }}
    steps:
      - name: Resolve dependencies
        id: resolve
        run: |
          echo "ğŸ“š Resolving dependencies for ${{ needs.environment_setup.outputs.env_name }}..."
          echo "ğŸ” Checking package.json and requirements files..."
          echo "âš¡ Analyzing dependency tree..."
          
          DEPS_HASH="deps-${{ needs.environment_setup.outputs.config_hash }}"
          CACHE_HIT="false"  # Educational simulation of cache miss
          
          echo "hash=$DEPS_HASH" >> "$GITHUB_OUTPUT"
          echo "cache_hit=$CACHE_HIT" >> "$GITHUB_OUTPUT"
          echo "âœ… Dependencies resolved: $DEPS_HASH"

  # Fan-out: Multiple parallel build paths
  frontend_build:
    name: Frontend Build
    runs-on: ubuntu-latest
    needs: [source_preparation, dependency_resolution]
    outputs:
      build_artifact: ${{ steps.build.outputs.artifact }}
      build_size: ${{ steps.build.outputs.size }}
    steps:
      - name: Build frontend
        id: build
        run: |
          echo "ğŸ¨ Building frontend application..."
          echo "ğŸ“¦ Source: ${{ needs.source_preparation.outputs.source_hash }}"
          echo "ğŸ“š Dependencies: ${{ needs.dependency_resolution.outputs.deps_hash }}"
          echo "âš™ï¸ Compiling React components and optimizing assets..."
          
          ARTIFACT="frontend-${{ needs.source_preparation.outputs.source_hash }}"
          SIZE="2.4MB"
          
          echo "artifact=$ARTIFACT" >> "$GITHUB_OUTPUT"
          echo "size=$SIZE" >> "$GITHUB_OUTPUT"
          echo "âœ… Frontend built: $ARTIFACT ($SIZE)"

  backend_build:
    name: Backend Build
    runs-on: ubuntu-latest  
    needs: [source_preparation, dependency_resolution]
    outputs:
      build_artifact: ${{ steps.build.outputs.artifact }}
      build_size: ${{ steps.build.outputs.size }}
    steps:
      - name: Build backend
        id: build
        run: |
          echo "ğŸ”§ Building backend services..."
          echo "ğŸ“¦ Source: ${{ needs.source_preparation.outputs.source_hash }}"
          echo "ğŸ“š Dependencies: ${{ needs.dependency_resolution.outputs.deps_hash }}"
          echo "âš¡ Compiling APIs and configuring microservices..."
          
          ARTIFACT="backend-${{ needs.source_preparation.outputs.source_hash }}"
          SIZE="15.7MB"
          
          echo "artifact=$ARTIFACT" >> "$GITHUB_OUTPUT" 
          echo "size=$SIZE" >> "$GITHUB_OUTPUT"
          echo "âœ… Backend built: $ARTIFACT ($SIZE)"

  database_migrations:
    name: Database Migrations
    runs-on: ubuntu-latest
    needs: [environment_setup, source_preparation]
    if: needs.environment_setup.outputs.env_name != 'development'
    outputs:
      migration_version: ${{ steps.migrate.outputs.version }}
    steps:
      - name: Run database migrations
        id: migrate
        run: |
          echo "ğŸ—„ï¸ Running migrations for ${{ needs.environment_setup.outputs.env_name }}..."
          echo "ğŸ“Š Updating database schema and seeding data..."
          
          # Static version for educational purposes
          VERSION="v20241225120000"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "âœ… Migrations completed: $VERSION"

  # Cross-cutting concern: monitoring setup
  monitoring_setup:
    name: Monitoring Setup
    runs-on: ubuntu-latest
    needs: environment_setup
    outputs:
      monitoring_ready: ${{ steps.setup.outputs.ready }}
    steps:
      - name: Configure monitoring
        id: setup
        run: |
          echo "ğŸ“Š Setting up monitoring for ${{ needs.environment_setup.outputs.env_name }}..."
          echo "ğŸ”” Configuring alerts and dashboards..."
          echo "ready=true" >> "$GITHUB_OUTPUT"
          echo "âœ… Monitoring configured"

  # Second level tests - depend on builds
  unit_tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [frontend_build, backend_build]
    outputs:
      test_results: ${{ steps.test.outputs.results }}
      coverage: ${{ steps.test.outputs.coverage }}
    steps:
      - name: Run unit tests
        id: test
        run: |
          echo "ğŸ§ª Running unit tests..."
          echo "ğŸ¨ Frontend artifact: ${{ needs.frontend_build.outputs.build_artifact }}"
          echo "ğŸ”§ Backend artifact: ${{ needs.backend_build.outputs.build_artifact }}"
          echo "âš¡ Testing individual components and functions..."
          
          RESULTS="passed"
          COVERAGE="87%"
          
          echo "results=$RESULTS" >> "$GITHUB_OUTPUT"
          echo "coverage=$COVERAGE" >> "$GITHUB_OUTPUT"
          echo "âœ… Unit tests $RESULTS with $COVERAGE coverage"

  integration_tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [frontend_build, backend_build, database_migrations, monitoring_setup]
    # Only run if database migrations completed OR we're in development
    if: always() && (needs.database_migrations.result == 'success' || needs.database_migrations.result == 'skipped')
    outputs:
      integration_results: ${{ steps.test.outputs.results }}
    steps:
      - name: Run integration tests
        id: test
        run: |
          echo "ğŸ”— Running integration tests..."
          echo "ğŸ—„ï¸ Database version: ${{ needs.database_migrations.outputs.migration_version || 'dev-local' }}"
          echo "ğŸ“Š Monitoring ready: ${{ needs.monitoring_setup.outputs.monitoring_ready }}"
          echo "ğŸŒ Testing end-to-end workflows and API integrations..."
          
          RESULTS="passed"
          echo "results=$RESULTS" >> "$GITHUB_OUTPUT"
          echo "âœ… Integration tests $RESULTS"

  # Conditional performance testing
  performance_tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: [environment_setup, frontend_build, backend_build]
    if: needs.environment_setup.outputs.performance_tests == 'true'
    outputs:
      perf_results: ${{ steps.test.outputs.results }}
      response_time: ${{ steps.test.outputs.avg_response }}
    steps:
      - name: Run performance tests
        id: test
        run: |
          echo "âš¡ Running performance tests..."
          echo "ğŸ¯ Environment: ${{ needs.environment_setup.outputs.env_name }}"
          echo "ğŸ“ˆ Load testing APIs and measuring response times..."
          echo "ğŸ”„ Testing concurrent user scenarios..."
          
          RESULTS="passed"
          AVG_RESPONSE="245ms"
          
          echo "results=$RESULTS" >> "$GITHUB_OUTPUT"
          echo "avg_response=$AVG_RESPONSE" >> "$GITHUB_OUTPUT"
          echo "âœ… Performance tests $RESULTS (avg: $AVG_RESPONSE)"

  # Environment-specific staging deployment
  staging_deployment:
    name: Staging Deployment
    runs-on: ubuntu-latest
    needs: [
      environment_setup,
      unit_tests,
      integration_tests,
      performance_tests
    ]
    # Only deploy to staging if it's not production and tests pass
    if: |
      needs.environment_setup.outputs.env_name != 'production' && 
      needs.unit_tests.outputs.test_results == 'passed' &&
      needs.integration_tests.outputs.integration_results == 'passed' &&
      (needs.performance_tests.result == 'success' || needs.performance_tests.result == 'skipped')
    outputs:
      deployment_url: ${{ steps.deploy.outputs.url }}
    steps:
      - name: Deploy to staging
        id: deploy
        run: |
          echo "ğŸš€ Deploying to staging environment..."
          echo "ğŸ“¦ Preparing deployment artifacts..."
          echo "ğŸ”§ Configuring staging infrastructure..."
          
          URL="https://staging-${{ needs.environment_setup.outputs.config_hash }}.example.com"
          echo "url=$URL" >> "$GITHUB_OUTPUT"
          echo "âœ… Deployed to: $URL"

  # Canary deployment path
  canary_preparation:
    name: Canary Preparation
    runs-on: ubuntu-latest
    needs: [environment_setup, staging_deployment]
    if: |
      needs.environment_setup.outputs.canary_enabled == 'true' &&
      needs.staging_deployment.result == 'success'
    outputs:
      canary_ready: ${{ steps.prep.outputs.ready }}
    steps:
      - name: Prepare canary deployment
        id: prep
        run: |
          echo "ğŸ¤ Preparing canary deployment..."
          echo "ğŸ“Š Analyzing staging deployment health..."
          echo "ready=true" >> "$GITHUB_OUTPUT"
          echo "âœ… Canary preparation complete"

  canary_deployment:
    name: Canary Deployment
    runs-on: ubuntu-latest
    needs: [environment_setup, canary_preparation]
    if: needs.canary_preparation.outputs.canary_ready == 'true'
    outputs:
      canary_url: ${{ steps.deploy.outputs.url }}
      traffic_split: ${{ steps.deploy.outputs.split }}
    steps:
      - name: Deploy canary version
        id: deploy
        run: |
          echo "ğŸ¤ Deploying canary version..."
          echo "ğŸ”€ Configuring traffic splitting..."
          echo "ğŸ“Š Setting up canary monitoring..."
          
          URL="https://canary-${{ needs.environment_setup.outputs.config_hash }}.example.com"
          SPLIT="10%"
          
          echo "url=$URL" >> "$GITHUB_OUTPUT"
          echo "split=$SPLIT" >> "$GITHUB_OUTPUT"
          echo "âœ… Canary deployed: $URL ($SPLIT traffic)"

  # Production deployment - multiple dependencies
  production_deployment:
    name: Production Deployment
    runs-on: ubuntu-latest
    needs: [
      environment_setup,
      unit_tests,
      integration_tests,
      performance_tests,
      staging_deployment,
      canary_deployment
    ]
    # Complex condition for production deployment
    if: |
      needs.environment_setup.outputs.env_name == 'production' &&
      needs.unit_tests.outputs.test_results == 'passed' &&
      needs.integration_tests.outputs.integration_results == 'passed' &&
      needs.performance_tests.outputs.perf_results == 'passed' &&
      (needs.canary_deployment.result == 'success' || needs.canary_deployment.result == 'skipped')
    outputs:
      prod_url: ${{ steps.deploy.outputs.url }}
    steps:
      - name: Deploy to production
        id: deploy
        run: |
          echo "ğŸš€ Deploying to production..."
          echo "âœ… All prerequisites validated"
          echo "ğŸŒ Rolling out to production infrastructure..."
          echo "ğŸ“Š Enabling production monitoring..."
          
          URL="https://app.example.com"
          echo "url=$URL" >> "$GITHUB_OUTPUT"
          echo "âœ… Production deployment complete: $URL"

  # Post-deployment verification
  smoke_tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: [staging_deployment, canary_deployment, production_deployment]
    # Run if any deployment succeeded
    if: |
      always() &&
      (needs.staging_deployment.result == 'success' || 
       needs.canary_deployment.result == 'success' || 
       needs.production_deployment.result == 'success')
    steps:
      - name: Run smoke tests
        run: |
          echo "ğŸ’¨ Running post-deployment smoke tests..."
          
          # Test staging if deployed
          if [ "${{ needs.staging_deployment.result }}" == "success" ]; then
            echo "ğŸ§ª Testing staging: ${{ needs.staging_deployment.outputs.deployment_url }}"
          fi
          
          # Test canary if deployed  
          if [ "${{ needs.canary_deployment.result }}" == "success" ]; then
            echo "ğŸ¤ Testing canary: ${{ needs.canary_deployment.outputs.canary_url }}"
            echo "ğŸ”€ Traffic split: ${{ needs.canary_deployment.outputs.traffic_split }}"
          fi
          
          # Test production if deployed
          if [ "${{ needs.production_deployment.result }}" == "success" ]; then
            echo "ğŸŒ Testing production: ${{ needs.production_deployment.outputs.prod_url }}"
          fi
          
          echo "âœ… All smoke tests passed"

  # Final aggregation and cleanup
  deployment_summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [
      environment_setup,
      security_scan,
      source_preparation,
      dependency_resolution,
      frontend_build,
      backend_build,
      database_migrations,
      monitoring_setup,
      unit_tests,
      integration_tests,
      performance_tests,
      staging_deployment,
      canary_deployment,
      production_deployment,
      smoke_tests
    ]
    if: always()
    steps:
      - name: Generate comprehensive summary
        run: |
          echo "ğŸ“‹ === Complex DAG Execution Summary ==="
          echo ""
          echo "ğŸ”§ Configuration:"
          echo "  Environment: ${{ needs.environment_setup.outputs.env_name }}"
          echo "  Canary enabled: ${{ needs.environment_setup.outputs.canary_enabled }}"
          echo "  Performance tests: ${{ needs.environment_setup.outputs.performance_tests }}"
          echo "  Config hash: ${{ needs.environment_setup.outputs.config_hash }}"
          echo ""
          
          echo "ğŸ” Security & Preparation:"
          echo "  Security scan: ${{ needs.security_scan.result }} (${{ needs.security_scan.outputs.vulnerabilities }} vulns)"
          echo "  Source preparation: ${{ needs.source_preparation.result }}"
          echo "  Dependency resolution: ${{ needs.dependency_resolution.result }}"
          echo ""
          
          echo "ğŸ—ï¸ Build Results:"
          echo "  Frontend: ${{ needs.frontend_build.result }} (${{ needs.frontend_build.outputs.build_size }})"
          echo "  Backend: ${{ needs.backend_build.result }} (${{ needs.backend_build.outputs.build_size }})"
          echo "  Database migrations: ${{ needs.database_migrations.result }}"
          echo ""
          
          echo "ğŸ§ª Testing Results:"
          echo "  Unit tests: ${{ needs.unit_tests.result }} (${{ needs.unit_tests.outputs.coverage }} coverage)"
          echo "  Integration tests: ${{ needs.integration_tests.result }}"
          echo "  Performance tests: ${{ needs.performance_tests.result }}"
          if [ "${{ needs.performance_tests.result }}" == "success" ]; then
            echo "    Average response: ${{ needs.performance_tests.outputs.response_time }}"
          fi
          echo ""
          
          echo "ğŸš€ Deployment Results:"
          echo "  Staging: ${{ needs.staging_deployment.result }}"
          if [ "${{ needs.staging_deployment.result }}" == "success" ]; then
            echo "    URL: ${{ needs.staging_deployment.outputs.deployment_url }}"
          fi
          echo "  Canary: ${{ needs.canary_deployment.result }}"
          if [ "${{ needs.canary_deployment.result }}" == "success" ]; then
            echo "    URL: ${{ needs.canary_deployment.outputs.canary_url }}"
            echo "    Traffic split: ${{ needs.canary_deployment.outputs.traffic_split }}"
          fi
          echo "  Production: ${{ needs.production_deployment.result }}"
          if [ "${{ needs.production_deployment.result }}" == "success" ]; then
            echo "    URL: ${{ needs.production_deployment.outputs.prod_url }}"
          fi
          echo ""
          
          echo "ğŸ’¨ Post-deployment:"
          echo "  Smoke tests: ${{ needs.smoke_tests.result }}"
          echo ""
          
          # Educational simplification of job counting
          echo "ğŸ“Š Overall Statistics:"
          echo "  This DAG demonstrates complex dependencies and fan-out/fan-in patterns"
          echo "  All jobs completed - demonstrating successful orchestration âœ…"

  # Cleanup resources
  cleanup:
    name: Cleanup Resources
    runs-on: ubuntu-latest
    needs: [deployment_summary]
    if: always()
    steps:
      - name: Cleanup temporary resources
        run: |
          echo "ğŸ§¹ Cleaning up temporary resources..."
          echo "ğŸ“¦ Simulating removal of build artifacts..."
          echo "ğŸ—ƒï¸ Simulating cache cleanup..."
          echo "âœ… Cleanup completed - resources freed for next run"